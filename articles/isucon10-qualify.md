---
title: "ISUCON10予選の作問を担当しました"
emoji: "🪑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ISUCON"]
published: false
---

この度、ISUCON10の運営に携わる機会を頂き、予選問題の作成を担当しました。
作問の際に考えていたことや狙いなどを、記録として記事に残すこととします。

## 運営に携わることになった経緯

私は株式会社リクルートの2020年度新卒としてリクルートテクノロジーズに入社しました。
新人研修の一環として実施されるOJTにて、予選問題作成に僕を含めて3名の新人がアサインされました。

僕がアサインされたタイミングでは、以下の二点が決まっているだけでした。

- テーマがISUUMOというイスと物件を購入できるサービスである
- 地図上をなぞって物件を探せる「なぞって検索」という目玉機能がある

[@yosuke_furukawa](https://twitter.com/yosuke_furukawa)さんを含む3名にメンターをしていただきながら、新卒組で仕様から決めていきました。

## 予選問題の狙い

ISUCONでは、チューニングの対象として故意的にアプリケーションやデータベースにボトルネックを作ります。
当初はどこにボトルネックを作るかの議論をしましたが、これを考えながら設計するのは非常に困難でした。
「これをやったら重そうだよね」というアタリを付けておき、実際にコードを書いていくと重たいアプリケーションが完成しました。

興味深いのは、これが意図したボトルネックと意図していなかったボトルネックが生まれることでした。
例えば今回の予選問題で言うと、なぞって検索や意図したボトルネックでしたが、昇順と降順を組み合わせたソートは意図せず生まれた天然のボトルネックでした。
こういう偶然生まれたボトルネックも問題として取り入れながら問題難易度の調整をしました。
実際に問題を作成してから解いてみると、想像以上に難しくスコアが全く上がらなかったため、難易度を下げるために一部ボトルネックの削除したり負荷の掛け方を変えたりと試行錯誤を行いました。

また個人的な狙いですが、予選問題は決勝に進出するチームを選出するための振るいの役割であるため、計測ができなければスコアが上がらないような問題を意識して作成しました。

## 実装の解説

次に、私が担当した部分を何を考えながら実装したかを交えながら解説していきます。

### フロントエンド

ISUCONのフロントエンド部分は動作の確認に用いられることが多く、特に今回はベンチマークの対象としなかったため簡易的に作成しました。
なぞって検索は、線が交差しても検索が行えるように凸法に変換するなどの処理を加えていますが、それ以外に特殊なことはしていません。
イス検索や物件検索の条件の数や、なぞって検索の機能がなんとなく重そうだということを意識してもらえるようにアプリケーションを組みました。

今回のベンチマーカーはトップページから順にサイトを訪問するようなシナリオを3つ持っていました。
また、フロントエンドに競技者の注意を向けさせないために、Next.jsでSSGをしてnginxから静的ファイル配信をするのみに留めました。

### バックエンド

今回の問題では、SQLに重点的なボトルネックを作るように意識しました。
これは複数言語で実装されるISUCONにおいて、どの言語でも同様の課題に直面するであろうと考えたからです。
実際に競技者の方が書いた記事などを見ても、SQLをどうチューニングするかという問題に向き合っていました。

### ベンチマーカー

予選問題でのスコア計算式は以下の通りでした。

```txt
スコア = (イスの購入件数 + 物件の資料請求件数) - 減点
```

これはISUUMOというサイトにおけるコンバージョン数を示しており、即ち「ユーザーに購入や資料請求をしてもらえるようなサイト」である必要があります。
しかし、Webサイトの表示に時間がかかってしまってはユーザーは離脱してしまいます。(参考: [Why does speed matter? | web.dev](https://web.dev/why-speed-matters/))

今回の問題では、Webサイトのトップページから順に以下の3種類のシナリオが実行され、Webサイトを表示するためのAPIが1秒以内に返ってこない場合はシナリオをやり直す仕様になっていました。

- イス検索シナリオ: トップページ → イス検索 → イス詳細 → イス購入 → イスによるおすすめ物件の詳細 → 物件の資料請求
- 物件検索シナリオ: トップページ → 物件検索 → 物件詳細 → 物件の資料請求
- なぞって検索シナリオ: トップページ →  なぞって検索 → 物件詳細 → 物件の資料請求

また、これとは別に以下のシナリオがありました。

- ボットシナリオ: イス検索と物件検索を定期的に実行する
- イス入稿シナリオ: 特定のタイミングでイスのCSV入稿を行う
- 物件入稿シナリオ: 特定のタイミングで物件のCSV入稿を行う

これらのシナリオを用いて自動負荷上昇を実現しました。
負荷の上昇はスコア (= コンバージョン数) が一定値を超えたタイミングで行われます。
この設定は[isucon/isucon10-qualify/bench/parameter/parameter.go](https://github.com/isucon/isucon10-qualify/blob/master/bench/parameter/parameter.go#L33-L146)にまとまっているので、そちらを参照してください。

## 負荷レベルごとの解説

ここからは、この負荷レベルごとの狙いやボトルネックについて解説していきます。

### Level 0 (1 ~ 299)

### Level 1 (300 ~ 599)

### Level 2 (600 ~ 799)

### Level 3 ~ (800 ~)

## 最後に

ISUCON10の予選問題作成の手伝いをするという前代未聞の新人研修でしたが、貴重な経験をさせてもらえました。
